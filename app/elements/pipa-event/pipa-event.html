<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="rss-feed.html">
<script src="../../bower_components/feed/src/feed.js"></script>
<script src="../../bower_components/lodash/lodash.js"></script>

<polymer-element name="pipa-event" attributes="reverse url feedType imgPrefix imgSelector interval updateInterval">
  <template>
    <link rel="stylesheet" href="pipa-event.css">
    <rss-feed id="feed" url="{{url}}" auto on-feed-parsed="{{handleResponse}}"></rss-feed>
    <div horizontal layout>
      <template id="tpl-image">
        <div id="image" class="{{ {'paddingl': reverse} | tokenList }}">
          <template if="{{image}}">
            <img id="image" src="{{image}}"></img>
          </template>
          <template if="{{!image}}">
            <img src="images/kp.jpg"></img>
          </template>
        </div>
      </template>
      <template id="tpl-content">
        <div id="content" class="{{ {'paddingl': !reverse} | tokenList }}" vertical layout flex>
          <header>

            <div id="title" horizontal layout>
              <div><font-awesome icon="star"></font-awesome></div>
              <div flex><a>{{caption}}</a></div>
            </div>

            <template if="{{feedType == 'events'}}">
              <div id="time">
                <div horizontal around-justified layout>
                  <div>
                    <font-awesome icon="clock-o"></font-awesome><a >{{time}}</a>
                  </div>
                  <template if="{{loc != ''}}">
                    <div>
                      <font-awesome icon="location-arrow"></font-awesome><a >{{loc}}</a>
                    </div>
                  </template>
                </div>
              </div>
            </template>

          </header>
          <main>
            <font-awesome icon="file-text-o"></font-awesome><a id="text">{{text}}</a>
          </main>
        <div>
      </template>
      <template if={{reverse}}>
        <template bind ref="tpl-content"></template>
        <template bind ref="tpl-image"></template>
      </template>
      <template if={{!reverse}}>
        <template bind ref="tpl-image"></template>
        <template bind ref="tpl-content"></template>
      </template>
    </div>
  </template>
  <script>
    (function () {

      Polymer({
        caption: "POT: Optimizacija spletnega streÅ¾nika",
        text: "This is some dummy text",
        loc: "Kiberpipa (Gosposvetska 2)",
        time: "Ponedeljek, 23. feb 2015 ob 17:00",
        reverse: false,
        imgPrefix: "http://www.kiberpipa.org",
        imgSelector: "thumbnail",

        currentPost: 0,
        interval: 10000,
        updateInterval: 600000,

        // define element prototype here
        ready: function() {
          setInterval(this.changeImage.bind(this), this.interval);
          setInterval(this.updateFeeds.bind(this), this.updateInterval);
        },

        updateFeeds: function() {
          this.$.feed.go();
        },

        handleResponse: function(e, result) {
          this.feed = result.feed;
          if (this.feedType == "events") {
            this.feed.items = _.filter(this.feed.items, function(entry) {
              return entry.pubDate > new Date();
            });
          } else if (this.feedType == "news") {
            this.feed.items = _.filter(this.feed.items, function(entry) {
              var d = new Date();
              d.setDate(d.getDate()-30);
              return entry.pubDate > d;
            });
          }

          this.changeImage();
        },

        changeImage: function() {
          if (typeof this.feed == 'undefined') { return; }

          var post = this.feed.items[this.currentPost];
          this.currentPost = (this.currentPost + 1) % this.feed.items.length;

          this.caption = post.title;
          this.time = post.pubDate.toLocaleDateString('sl-SI', {month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric'});
          this.text = this.strip(post.description);
          this.location = post.location;
          if (post._source.querySelector(this.imgSelector)) {
            this.image =
              this.imgPrefix +
              post._source.querySelector(this.imgSelector).getAttribute("url");
          }
        },

        strip: function(html) {
           var tmp = document.createElement("DIV");
           tmp.innerHTML = html;
           return tmp.textContent || tmp.innerText || "";
        }
      });

    })();
  </script>
</polymer-element>
